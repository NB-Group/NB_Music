// ==UserScript==
// @name         ç®€åŒ–ç‰ˆ - ç¬¬ä¸‰æ–¹ VIP è§†é¢‘è§£æç¤ºä¾‹
// @namespace    simplified-vip-parser-example
// @version      0.5
// @description  æ¼”ç¤ºä½¿ç”¨ç¬¬ä¸‰æ–¹æ¥å£å°è¯•è§£æ VIP è§†é¢‘çš„æ ¸å¿ƒé€»è¾‘ (ç®€åŒ–ç‰ˆ)
// @author       AI & å‚è€ƒæºè„šæœ¬
// @match        *://*.youku.com/*
// @match        *://*.iqiyi.com/*
// @match        *://*.iq.com/*
// @match        *://*.le.com/*
// @match        *://v.qq.com/*
// @match        *://*.mgtv.com/*
// @match        *://*.bilibili.com/*
// @match        *://tv.sohu.com/*
// @match        *://film.sohu.com/*
// @match        *://*.1905.com/*
// @match        *://*.pptv.com/*
// @exclude      *://*.bilibili.com/appeal*
// @grant        GM_addStyle
// @grant        GM_registerMenuCommand
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_openInTab
// @run-at       document-idle
// ==/UserScript==

(function() \{
    'use strict';

    // --- é…ç½® ---
    const SCRIPT_ID = 'simplifiedVipParser';
    const PARSE_EXTERNALLY_KEY = 'simplifiedVipParser_parseExternally';

    // è·å–è®¾ç½®ï¼Œé»˜è®¤ä¸º true (ç«™å¤–è§£æ)
    let parseExternally = GM_getValue(PARSE_EXTERNALLY_KEY, true);

    // --- ç¬¬ä¸‰æ–¹è§£ææ¥å£åˆ—è¡¨ (ç¤ºä¾‹ï¼Œå¯èƒ½å¤±æ•ˆ) ---
    // è¿™äº›æ˜¯ä»ä½ æä¾›çš„è„šæœ¬ä¸­æŒ‘é€‰çš„å‡ ä¸ªä¾‹å­
    const parsingInterfaces = [
        { name: "çº¯å‡€1", url: "https://im1907.top/?jx=" \},
        \{ name: "Bç«™1", url: "https://jx.jsonplayer.com/player/?url=" \},
        \{ name: "å¬ä¹", url: "https://jx.dj6u.com/?url=" \},
        \{ name: "ç›˜å¤", url: "https://www.pangujiexi.cc/jiexi.php?url=" \},
        \{ name: "è™¾ç±³", url: "https://jx.xmflv.com/?url=" \},
        // --- ä½ å¯ä»¥è‡ªå·±æ·»åŠ æ›´å¤šæˆ–ä¿®æ”¹è¿™é‡Œçš„æ¥å£ ---
        // \{ name: "è‡ªå®šä¹‰çº¿è·¯å", url: "https://your.custom.interface/?url=" \},
    ];

    // --- æ ·å¼ ---
    GM_addStyle(`
        #$\{SCRIPT_ID\}_button \{
            position: fixed;
            top: 200px;
            left: 10px;
            z-index: 99999;
            background-color: #f24443;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            opacity: 0.8;
            transition: opacity 0.3s;
        \}
        #$\{SCRIPT_ID\}_button:hover \{
            opacity: 1;
        \}
        #$\{SCRIPT_ID\}_popup \{
            position: fixed;
            top: 240px; /* Button height + spacing */
            left: 10px;
            z-index: 99998;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            padding: 10px;
            display: none; /* Initially hidden */
            max-height: 300px;
            overflow-y: auto;
        \}
        #$\{SCRIPT_ID\}_popup ul \{
            list-style: none;
            padding: 0;
            margin: 0;
        \}
        #$\{SCRIPT_ID\}_popup li \{
            padding: 6px 8px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 13px;
            color: #333;
        \}
         #$\{SCRIPT_ID\}_popup li:last-child \{
             border-bottom: none;
         \}
        #$\{SCRIPT_ID\}_popup li:hover \{
            background-color: #f0f0f0;
            color: #f24443;
        \}
        #$\{SCRIPT_ID\}_iframe_container \{
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 100000; /* Above everything */
            background-color: rgba(0, 0, 0, 0.7); /* Dim background */
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        \}
         #$\{SCRIPT_ID\}_iframe_wrapper \{
             position: relative;
             width: 90%;
             height: 90%;
             background-color: black;
             border-radius: 5px;
             overflow: hidden; /* Clip iframe corners */
         \}
        #$\{SCRIPT_ID\}_iframe \{
            width: 100%;
            height: 100%;
            border: none;
        \}
         #$\{SCRIPT_ID\}_iframe_close \{
             position: absolute;
             top: -5px;
             right: -5px;
             width: 28px;
             height: 28px;
             background-color: white;
             color: #555;
             border: 1px solid #ccc;
             border-radius: 50%;
             text-align: center;
             line-height: 26px;
             font-size: 20px;
             font-weight: bold;
             cursor: pointer;
             box-shadow: 0 1px 3px rgba(0,0,0,0.3);
         \}
         #$\{SCRIPT_ID\}_iframe_close:hover \{
             background-color: #f0f0f0;
             color: black;
         \}
    `);

    // --- åˆ›å»º UI å…ƒç´  ---
    function createUI() \{
        // æ£€æŸ¥æ˜¯å¦å·²åˆ›å»º
        if (document.getElementById(`${SCRIPT_ID\}_button`)) \{
            return;
        \}

        // 1. åˆ›å»ºæ‚¬æµ®æŒ‰é’®
        const button = document.createElement('button');
        button.id = `$\{SCRIPT_ID\}_button`;
        button.textContent = 'VIP è§£æ';
        button.title = 'ç‚¹å‡»é€‰æ‹©è§£æçº¿è·¯';
        document.body.appendChild(button);

        // 2. åˆ›å»ºçº¿è·¯é€‰æ‹©å¼¹å‡ºæ¡† (åˆå§‹éšè—)
        const popup = document.createElement('div');
        popup.id = `$\{SCRIPT_ID\}_popup`;
        const ul = document.createElement('ul');
        parsingInterfaces.forEach(item => \{
            const li = document.createElement('li');
            li.textContent = item.name;
            li.dataset.url = item.url; // å°†æ¥å£ URL å­˜å‚¨åœ¨ data å±æ€§ä¸­
            li.title = `ä½¿ç”¨ ${item.name\} è§£æ`;
            li.addEventListener('click', handleInterfaceClick);
            ul.appendChild(li);
        });
        popup.appendChild(ul);
        document.body.appendChild(popup);

        // 3. åˆ›å»ºç”¨äºç«™å†…è§£æçš„ iframe å®¹å™¨ (åˆå§‹éšè—)
        const iframeContainer = document.createElement('div');
        iframeContainer.id = `$\{SCRIPT_ID\}_iframe_container`;
        iframeContainer.innerHTML = `
            <div id="$\{SCRIPT_ID\}_iframe_wrapper">
                <iframe id="$\{SCRIPT_ID\}_iframe" allowfullscreen="true" sandbox="allow-forms allow-scripts allow-same-origin"></iframe>
                <div id="$\{SCRIPT_ID\}_iframe_close" title="å…³é—­æ’­æ”¾å™¨">&times;</div>
            </div>
        `;
        document.body.appendChild(iframeContainer);

        // --- äº‹ä»¶ç›‘å¬ ---
        // ç‚¹å‡»æŒ‰é’®æ˜¾ç¤º/éšè—çº¿è·¯åˆ—è¡¨
        button.addEventListener('click', (e) => \{
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ° document
            popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
        \});

        // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹éšè—çº¿è·¯åˆ—è¡¨
        document.addEventListener('click', (e) => \{
            if (!popup.contains(e.target) && e.target !== button) {
                popup.style.display = 'none';
            \}
        });

        // ç‚¹å‡»å…³é—­æŒ‰é’®éšè— iframe å®¹å™¨
        document.getElementById(`$\{SCRIPT_ID\}_iframe_close`).addEventListener('click', () => \{
            const container = document.getElementById(`${SCRIPT_ID\}_iframe_container`);
            const iframe = document.getElementById(`$\{SCRIPT_ID\}_iframe`);
            iframe.src = 'about:blank'; // æ¸…ç©º iframe å†…å®¹ï¼Œåœæ­¢æ’­æ”¾
            container.style.display = 'none';
        });
    }

    // --- å¤„ç†çº¿è·¯ç‚¹å‡» ---
    function handleInterfaceClick(event) \{
        const interfaceUrl = event.target.dataset.url;
        const currentVideoUrl = window.location.href;

        if (!interfaceUrl) {
            console.error('è§£ææ¥å£ URL æœªæ‰¾åˆ°!');
            alert('é€‰æ‹©çš„è§£ææ¥å£æ— æ•ˆï¼');
            return;
        \}

        // éšè—çº¿è·¯åˆ—è¡¨
        const popup = document.getElementById(`$\{SCRIPT_ID\}_popup`);
        if (popup) popup.style.display = 'none';

        // **é‡è¦ï¼šå¯¹å½“å‰è§†é¢‘ URL è¿›è¡Œç¼–ç ï¼Œé˜²æ­¢å‚æ•°è¢«æˆªæ–­æˆ–è§£æé”™è¯¯**
        const encodedVideoUrl = encodeURIComponent(currentVideoUrl);
        const finalUrl = interfaceUrl + encodedVideoUrl;

        console.log(`å°è¯•ä½¿ç”¨æ¥å£: $\{event.target.textContent\}`);
        console.log(`è§£æç›®æ ‡ URL: $\{currentVideoUrl\}`);
        console.log(`æœ€ç»ˆè¯·æ±‚ URL: $\{finalUrl\}`);

        if (parseExternally) \{
            // æ–¹å¼ä¸€ï¼šç«™å¤–è§£æ (æ–°æ ‡ç­¾é¡µæ‰“å¼€)
            console.log('æ‰§è¡Œç«™å¤–è§£æ...');
            // GM_openInTab(finalUrl, { active: true \}); // ä½¿ç”¨ GM åŠŸèƒ½æ‰“å¼€
            window.open(finalUrl, '_blank'); // å¤‡ç”¨ï¼Œå¦‚æœ GM_openInTab æœ‰é—®é¢˜
        } else \{
            // æ–¹å¼äºŒï¼šç«™å†…è§£æ (å°è¯•ä½¿ç”¨ iframe)
            console.log('æ‰§è¡Œç«™å†…è§£æ (ä½¿ç”¨ iframe)...');
            const iframeContainer = document.getElementById(`${SCRIPT_ID\}_iframe_container`);
            const iframe = document.getElementById(`$\{SCRIPT_ID\}_iframe`);
            if (iframe && iframeContainer) \{
                iframe.src = finalUrl;
                iframeContainer.style.display = 'flex'; // æ˜¾ç¤º iframe å®¹å™¨
            \} else \{
                console.error('ç«™å†…è§£æ iframe æœªæ‰¾åˆ°!');
                alert('ç«™å†…è§£ææ‰€éœ€çš„æ’­æ”¾å™¨ç»„ä»¶æœªæ‰¾åˆ°ï¼Œè¯·å°è¯•ç«™å¤–è§£æã€‚');
                // å‡ºé”™æ—¶ä¹Ÿå°è¯•ç«™å¤–æ‰“å¼€
                 window.open(finalUrl, '_blank');
            \}
        }
    }

    // --- èœå•å‘½ä»¤ ---
    function registerMenu() \{
        const menuText = parseExternally ? 'â–¶ï¸ å½“å‰æ¨¡å¼: ç«™å¤–è§£æ (ç‚¹å‡»åˆ‡æ¢ä¸ºç«™å†…)' : 'ğŸ“º å½“å‰æ¨¡å¼: ç«™å†…è§£æ (ç‚¹å‡»åˆ‡æ¢ä¸ºç«™å¤–)';
        GM_registerMenuCommand(menuText, () => {
            parseExternally = !parseExternally;
            GM_setValue(PARSE_EXTERNALLY_KEY, parseExternally);
            alert(`è§£ææ¨¡å¼å·²åˆ‡æ¢ä¸º: ${parseExternally ? 'ç«™å¤–è§£æ (æ–°æ ‡ç­¾é¡µ)' : 'ç«™å†…è§£æ (å°è¯•åµŒå…¥)'\}\nåˆ·æ–°é¡µé¢ç”Ÿæ•ˆè®¾ç½®æ˜¾ç¤ºã€‚`);
            // é‡æ–°æ³¨å†Œèœå•ä»¥æ›´æ–°æ–‡æœ¬ (è™½ç„¶åœ¨æ­¤æ¬¡ç‚¹å‡»åä¸ç«‹å³æ˜¾ç¤ºï¼Œä½†ä¸‹æ¬¡æ‰“å¼€èœå•æ—¶ä¼šæ›´æ–°)
            // å¯ä»¥è€ƒè™‘ç§»é™¤æ—§å‘½ä»¤å†æ·»åŠ ï¼Œä½† GM API å¯èƒ½ä¸æ”¯æŒåŠ¨æ€ç§»é™¤ï¼Œç®€å•åšæ³•æ˜¯ä¸‹æ¬¡è¿è¡Œæ—¶æ–‡æœ¬å°±å¯¹äº†
        });
    }

    // --- åˆå§‹åŒ– ---
    // å»¶è¿Ÿä¸€ç‚¹æ‰§è¡Œï¼Œç¡®ä¿é¡µé¢åŸºæœ¬åŠ è½½
    setTimeout(() => \{
        createUI();
        registerMenu();
        console.log(`ç®€åŒ–ç‰ˆ VIP è§£æè„šæœ¬å·²åŠ è½½ï¼Œå½“å‰æ¨¡å¼: ${parseExternally ? 'ç«™å¤–' : 'ç«™å†…'\}`);
    }, 1500); // 1.5 ç§’å»¶è¿Ÿï¼Œå¯æ ¹æ®éœ€è¦è°ƒæ•´

})();